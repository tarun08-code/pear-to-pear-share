<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple File Share - PeerJS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #2196F3;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .alert {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      padding: 15px;
      margin: 20px;
      border-radius: 4px;
      text-align: center;
    }

    .main-content {
      display: flex;
      min-height: 500px;
    }

    .send-section,
    .receive-section {
      flex: 1;
      padding: 30px;
    }

    .send-section {
      border-right: 2px solid #eee;
    }

    h2 {
      margin-bottom: 20px;
      color: #333;
    }

    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .drop-zone:hover {
      border-color: #2196F3;
      background: #f0f8ff;
    }

    .drop-zone.dragover {
      border-color: #2196F3;
      background: #e3f2fd;
    }

    .file-input {
      display: none;
    }

    .file-info {
      background: #e8f5e8;
      border: 1px solid #4caf50;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      display: none;
    }

    .file-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .file-size {
      color: #666;
      font-size: 14px;
    }

    .share-code-display {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    .share-code {
      font-size: 24px;
      font-weight: bold;
      color: #856404;
      letter-spacing: 2px;
      margin: 10px 0;
      user-select: all;
    }

    .code-input {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 4px;
      text-align: center;
      letter-spacing: 2px;
      margin-bottom: 15px;
    }

    .btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s ease;
    }

    .btn:hover {
      background: #1976D2;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .copy-btn {
      background: #4caf50;
      padding: 10px 20px;
      font-size: 14px;
      width: auto;
      margin-top: 10px;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
      display: none;
    }

    .status.connected {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      display: block;
    }

    .download-area {
      margin-top: 20px;
    }

    .file-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .download-btn {
      background: #28a745;
      padding: 8px 16px;
      font-size: 14px;
      width: auto;
    }

    .instructions {
      margin: 20px;
      padding: 20px;
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
    }

    .instructions h3 {
      margin-bottom: 10px;
      color: #1976D2;
    }

    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }

      .send-section {
        border-right: none;
        border-bottom: 2px solid #eee;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš€ Simple File Share - PeerJS</h1>
      <p>Direct peer-to-peer file sharing using PeerJS signaling</p>
    </div>

    <div class="alert">
      <strong>âœ¨ Powered by PeerJS!</strong> Automatic signaling server - just share the room code!
    </div>

    <div class="instructions">
      <h3>ðŸ“‹ How to use:</h3>
      <p><strong>1. SENDER:</strong> Select files â†’ Click "Create Room" â†’ Share the room code<br>
        <strong>2. RECEIVER:</strong> Enter the room code â†’ Click "Connect" â†’ Download files<br>
        <strong>3.</strong> Files transfer directly between browsers!
      </p>
    </div>

    <div class="main-content">
      <!-- SEND FILES SECTION -->
      <div class="send-section">
        <h2>ðŸ“¤ SEND FILES</h2>

        <div class="drop-zone" id="dropZone">
          <p>Drag files here or click to select</p>
          <small>Any file type, any size</small>
        </div>

        <input type="file" id="fileInput" class="file-input" multiple>

        <div class="file-info" id="fileInfo">
          <div class="file-name" id="fileName"></div>
          <div class="file-size" id="fileSize"></div>
        </div>

        <button class="btn" id="generateCodeBtn" disabled>Create Room</button>

        <div class="share-code-display" id="shareCodeDisplay">
          <p>Share this room code with receivers:</p>
          <div class="share-code" id="shareCode"></div>
          <button class="btn copy-btn" id="copyCodeBtn">Copy Code</button>
          <p><small>Keep this page open while others download</small></p>
        </div>

        <div class="status" id="sendStatus"></div>
        <div class="download-area" id="senderFiles"></div>
      </div>

      <!-- RECEIVE FILES SECTION -->
      <div class="receive-section">
        <h2>ðŸ“¥ RECEIVE FILES</h2>

        <input type="text" class="code-input" id="codeInput" placeholder="Enter Room Code" maxlength="20">

        <button class="btn" id="connectBtn">Connect</button>

        <div class="status" id="receiveStatus"></div>

        <div class="download-area" id="downloadArea"></div>
      </div>
    </div>
  </div>

  <!-- PeerJS CDN -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <script>
    // Global variables
    let selectedFiles = [];
    let shareCode = '';
    let peer = null;
    let connections = [];
    let isSender = false;

    // DOM elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const generateCodeBtn = document.getElementById('generateCodeBtn');
    const shareCodeDisplay = document.getElementById('shareCodeDisplay');
    const shareCodeEl = document.getElementById('shareCode');
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const sendStatus = document.getElementById('sendStatus');
    const senderFiles = document.getElementById('senderFiles');

    const codeInput = document.getElementById('codeInput');
    const connectBtn = document.getElementById('connectBtn');
    const receiveStatus = document.getElementById('receiveStatus');
    const downloadArea = document.getElementById('downloadArea');

    // Initialize PeerJS
    function initializePeer(id = null) {
      peer = new Peer(id, {
        host: 'peerjs-server.herokuapp.com',
        port: 443,
        path: '/',
        secure: true,
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        }
      });

      peer.on('open', (id) => {
        console.log('Peer ID:', id);
        if (isSender) {
          shareCode = id;
          shareCodeEl.textContent = shareCode;
          shareCodeDisplay.style.display = 'block';
          showStatus(sendStatus, 'âœ… Room created! Share the code with receivers.', 'connected');
        }
      });

      peer.on('connection', (conn) => {
        console.log('Incoming connection from:', conn.peer);
        connections.push(conn);
        setupConnection(conn);
        showStatus(sendStatus, `âœ… ${connections.length} peer(s) connected`, 'connected');
        displaySenderFiles();
      });

      peer.on('error', (err) => {
        console.error('PeerJS error:', err);
        showStatus(isSender ? sendStatus : receiveStatus, `âŒ Connection error: ${err.type}`, 'error');
      });
    }

    // Setup connection handlers
    function setupConnection(conn) {
      let currentFileData = null;

      conn.on('open', () => {
        console.log('Connection opened with:', conn.peer);

        if (isSender) {
          // Send file list to receiver
          const fileList = selectedFiles.map((file, index) => ({
            index,
            name: file.name,
            size: file.size,
            type: file.type
          }));

          conn.send({
            type: 'file-list',
            files: fileList
          });
        }
      });

      conn.on('data', async (data) => {
        console.log('Received data:', data);

        if (data.type === 'file-request' && isSender) {
          // Send requested file
          const fileIndex = data.index;
          if (selectedFiles[fileIndex]) {
            await sendFile(selectedFiles[fileIndex], conn);
          }

        } else if (data.type === 'file-list' && !isSender) {
          // Display available files
          displayAvailableFiles(data.files);

        } else if (data.type === 'file-info' && !isSender) {
          // Prepare to receive file
          currentFileData = {
            name: data.name,
            size: data.size,
            type: data.fileType,
            data: new Uint8Array(data.size),
            received: 0
          };
          showStatus(receiveStatus, `ðŸ“¥ Receiving ${data.name}...`, 'connected');

        } else if (data.type === 'file-chunk' && !isSender) {
          // Receive file chunk
          if (currentFileData) {
            const chunk = new Uint8Array(data.data);
            currentFileData.data.set(chunk, data.offset);
            currentFileData.received += chunk.length;

            const progress = (currentFileData.received / currentFileData.size) * 100;
            showStatus(receiveStatus, `ðŸ“¥ Downloading ${currentFileData.name}: ${progress.toFixed(1)}%`, 'connected');

            if (currentFileData.received === currentFileData.size) {
              downloadFile(currentFileData);
              showStatus(receiveStatus, `âœ… Downloaded: ${currentFileData.name}`, 'connected');
              currentFileData = null;
            }
          }
        }
      });

      conn.on('close', () => {
        console.log('Connection closed with:', conn.peer);
        connections = connections.filter(c => c !== conn);
        if (isSender) {
          showStatus(sendStatus, `ðŸ“¡ ${connections.length} peer(s) connected`, 'connected');
        } else {
          showStatus(receiveStatus, 'ðŸ“¡ Connection closed', 'error');
        }
      });

      conn.on('error', (err) => {
        console.error('Connection error:', err);
        showStatus(isSender ? sendStatus : receiveStatus, 'âŒ Connection error', 'error');
      });
    }

    // File selection handlers
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // Handle selected files
    function handleFiles(files) {
      if (files.length > 0) {
        selectedFiles = Array.from(files);
        displayFileInfo();
        generateCodeBtn.disabled = false;
      }
    }

    // Display file information
    function displayFileInfo() {
      if (selectedFiles.length === 1) {
        fileName.textContent = selectedFiles[0].name;
        fileSize.textContent = formatFileSize(selectedFiles[0].size);
      } else {
        fileName.textContent = `${selectedFiles.length} files selected`;
        const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
        fileSize.textContent = `Total: ${formatFileSize(totalSize)}`;
      }
      fileInfo.style.display = 'block';
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Generate share code and start as sender
    generateCodeBtn.addEventListener('click', async () => {
      isSender = true;
      showStatus(sendStatus, 'ðŸ”„ Creating room...', 'connected');

      // Generate a user-friendly room code
      const roomId = 'room-' + Math.random().toString(36).substr(2, 8);
      initializePeer(roomId);
    });

    // Copy code to clipboard
    copyCodeBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(shareCode);
        copyCodeBtn.textContent = 'âœ… Copied!';
        setTimeout(() => {
          copyCodeBtn.textContent = 'Copy Code';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = shareCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        copyCodeBtn.textContent = 'âœ… Copied!';
        setTimeout(() => {
          copyCodeBtn.textContent = 'Copy Code';
        }, 2000);
      }
    });

    // Connect to sender as receiver
    connectBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim();
      if (!code) {
        showStatus(receiveStatus, 'âŒ Please enter a room code', 'error');
        return;
      }

      isSender = false;
      showStatus(receiveStatus, `ðŸ”„ Connecting to ${code}...`, 'connected');

      initializePeer();

      peer.on('open', () => {
        console.log('Connecting to peer:', code);
        const conn = peer.connect(code);
        connections.push(conn);
        setupConnection(conn);
      });
    });

    // Send file through connection
    async function sendFile(file, conn) {
      if (conn.open) {
        // Send file info
        conn.send({
          type: 'file-info',
          name: file.name,
          size: file.size,
          fileType: file.type
        });

        // Send file in chunks
        const chunkSize = 16384; // 16KB chunks
        let offset = 0;

        while (offset < file.size) {
          const chunk = file.slice(offset, offset + chunkSize);
          const arrayBuffer = await readFileChunk(chunk);

          conn.send({
            type: 'file-chunk',
            data: Array.from(new Uint8Array(arrayBuffer)),
            offset: offset
          });

          offset += chunkSize;

          // Small delay to prevent overwhelming
          await new Promise(resolve => setTimeout(resolve, 10));
        }

        showStatus(sendStatus, `âœ… Sent: ${file.name}`, 'connected');
      }
    }

    // Read file chunk
    function readFileChunk(chunk) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsArrayBuffer(chunk);
      });
    }

    // Download received file
    function downloadFile(fileData) {
      const blob = new Blob([fileData.data], { type: fileData.type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileData.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Display sender files
    function displaySenderFiles() {
      senderFiles.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <div>
            <strong>${file.name}</strong><br>
            <small>${formatFileSize(file.size)}</small>
          </div>
          <div style="color: #28a745; font-weight: bold;">Ready to send</div>
        `;
        senderFiles.appendChild(fileItem);
      });
    }

    // Display available files (receiver side)
    function displayAvailableFiles(files) {
      downloadArea.innerHTML = '';
      showStatus(receiveStatus, 'ðŸ“ Files available for download:', 'connected');

      files.forEach((file) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <div>
            <strong>${file.name}</strong><br>
            <small>${formatFileSize(file.size)}</small>
          </div>
          <button class="btn download-btn" onclick="requestFile(${file.index})" id="btn-${file.index}">Download</button>
        `;
        downloadArea.appendChild(fileItem);
      });
    }

    // Request file download
    function requestFile(index) {
      if (connections.length > 0 && connections[0].open) {
        connections[0].send({
          type: 'file-request',
          index: index
        });

        const button = document.getElementById(`btn-${index}`);
        button.textContent = 'Downloading...';
        button.disabled = true;
      }
    }

    // Show status message
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = `status ${type}`;
    }

    // Auto-format code input
    codeInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    // Make requestFile available globally
    window.requestFile = requestFile;
  </script>
</body>

</html>